name: è‡ªåŠ¨éƒ¨ç½² - ä»æŒ‡å®šç›®å½•è§£å‹å¹¶å‘å¸ƒ
description: æ‰¾å‡ºæŒ‡å®šæ–‡ä»¶å¤¹ä¸­æœ€æ–°çš„ zip åŒ…ï¼Œè§£å‹åæ›¿æ¢æ ¹ç›®å½•å†…å®¹ï¼Œå¹¶è‡ªåŠ¨æäº¤ã€‚
author: Yian

# è¾“å…¥å‚æ•°
inputs:
  File_directory:
    description: "zip æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œé»˜è®¤æ˜¯ public"
    required: false
    default: "public"
  exclude_files:
    description: |
      åœ¨é»˜è®¤ä¿ç•™é¡¹ï¼ˆ.git|.github|public|tempï¼‰åŸºç¡€ä¸Šï¼Œé¢å¤–ä¿ç•™çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼ˆç”¨ | åˆ†éš”ï¼‰ã€‚
      ä¾‹å¦‚å¡«å†™ï¼šCNAME|README.mdï¼Œåˆ™æœ€ç»ˆä¿ç•™é¡¹ä¸º .git|.github|public|temp|CNAME|README.md
    required: false
    default: "" # æ³¨æ„ï¼šæ­¤æ—¶ default å¯è®¾ä¸ºç©ºï¼Œå› ä¸ºé€»è¾‘ä¸Šå·²å†…ç½®é»˜è®¤å€¼
  delete_zip_directory:
    description: "æ˜¯å¦åˆ é™¤ zip ç›®å½•? true æˆ– false é»˜è®¤æ˜¯åˆ é™¤"
    required: false
    default: "true"

# å®šä¹‰è¿è¡Œç¯å¢ƒå’Œæ­¥éª¤
runs:
  using: "composite"
  steps:
    # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»£ç 
    - name: æ‹‰å–ä»£ç 
    - uses: actions/checkout@v2

    # æ£€æŸ¥æ˜¯ä¸æ˜¯å­˜åœ¨ File_directory æ–‡ä»¶å¤¹
    - name: æ£€æŸ¥ File_directory ç›®å½•æ˜¯å¦å­˜åœ¨
      shell: bash
      run: |
        DIR="${{ inputs.File_directory }}"
        if [ -d "$DIR" ]; then
          echo "âœ… $DIR ç›®å½•å­˜åœ¨"
        else
          echo "âŒ é”™è¯¯ï¼š$DIR ç›®å½•ä¸å­˜åœ¨ï¼è¯·ç¡®è®¤æœ‰ç”Ÿæˆ zip æ–‡ä»¶ã€‚" >&2
          exit 1
        fi

    # ç¬¬ä¸‰æ­¥ï¼šæ‰¾å‡ºæœ€æ–°çš„æ–‡ä»¶
    - name: æŸ¥æ‰¾æœ€æ–°çš„æ–‡ä»¶
      shell: bash
      run: |
        cd "${{ inputs.File_directory }}" || { echo "âŒ è¿›å…¥ç›®å½•å¤±è´¥"; exit 1; }
        LATEST=$(ls -t *.zip 2>/dev/null | head -n 1)
        if [ -z "$LATEST" ]; then
          echo "âŒ æ²¡æœ‰åœ¨ ${{ inputs.File_directory }} æ‰¾åˆ°ä»»ä½• zip æ–‡ä»¶"
          exit 1
        else
          echo "ğŸ“¦ æ‰¾åˆ°æœ€æ–°å‹ç¼©åŒ…ï¼š$LATEST"
          echo "LATEST_ZIP=$LATEST" >> $GITHUB_ENV
        fi

    # ç¬¬å››æ­¥ï¼šè§£å‹åˆ° temp æ–‡ä»¶å¤¹
    - name: è§£å‹æ–‡ä»¶åˆ° temp
      shell: bash
      run: |
        cd "${{ inputs.File_directory }}" || { echo "$DIR" ç›®å½•ä¸å­˜åœ¨æˆ–æ— æ³•è¿›å…¥"; exit 1; }
        unzip -o "$LATEST_ZIP" -d ../temp || { echo "è§£å‹å¤±è´¥"; exit 1; }
        echo "âœ… è§£å‹å®Œæˆ"

    # ç¬¬äº”æ­¥ï¼šåˆ›å»ºä¿ç•™æ–‡ä»¶åˆ—è¡¨
    - name: åˆ›å»ºä¿ç•™æ–‡ä»¶åˆ—è¡¨
      shell: bash
      run: |
        DEFAULT_EXCLUDES=".git|.github|temp|${{ inputs.File_directory }}"
        if [ -z "${{ inputs.exclude_files }}" ]; then
          EXCLUDE_PATTERN="$DEFAULT_EXCLUDES"
        else
          EXCLUDE_PATTERN="$DEFAULT_EXCLUDES|${{ inputs.exclude_files }}"
        fi
        echo "ä¿ç•™æ–‡ä»¶æ¨¡å¼ï¼š$EXCLUDE_PATTERN"
        echo "EXCLUDE_PATTERN=$EXCLUDE_PATTERN" >> $GITHUB_ENV

    # ç¬¬å…­æ­¥ï¼šæ¸…ç†æ ¹ç›®å½•ï¼ˆä¿ç•™æŒ‡å®šæ–‡ä»¶ï¼‰
    - name: æ¸…ç†æ—§æ–‡ä»¶
      shell: bash
      run: |
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ ¹ç›®å½•... ä¿ç•™ï¼š$EXCLUDE_PATTERN"

        for item in ./*; do
          basename="${item#./}"
          
          case "|$EXCLUDE_PATTERN|" in
            *"|$basename|"*)
              echo "ğŸ” ä¿ç•™: $item"
              ;;
            *)
              echo "ğŸ—‘ï¸ åˆ é™¤: $item"
              rm -rf "$item"
          esac
        done
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: ç§»åŠ¨æ–°æ–‡ä»¶åˆ°æ ¹ç›®å½•
      shell: bash
      run: |
        echo "ğŸšš å¼€å§‹ç§»åŠ¨ temp/ ä¸­çš„æ–‡ä»¶åˆ°æ ¹ç›®å½•..."

        # æ£€æŸ¥ temp æ˜¯å¦å­˜åœ¨ä¸”ä¸ºç›®å½•
        if [ ! -d "temp" ]; then
          echo "ğŸ”¸ temp ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ç§»åŠ¨ã€‚"
          echo "âœ… æ–‡ä»¶ç§»åŠ¨å®Œæˆï¼ˆæ— æ–‡ä»¶å¯ç§»åŠ¨ï¼‰"
          exit 0
        fi

        # æ£€æŸ¥ temp æ˜¯å¦ä¸ºç©º
        if [ -z "$(ls -A temp 2>/dev/null)" ]; then
          echo "ğŸ”¸ temp ç›®å½•ä¸ºç©ºï¼Œæ— éœ€ç§»åŠ¨æ–‡ä»¶ã€‚"
          rm -rf temp && echo "ğŸ—‘ï¸ å·²æ¸…ç†ç©ºçš„ temp ç›®å½•"
        else
          # ç§»åŠ¨æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼Œé™¤äº† . å’Œ ..ï¼‰
          mv temp/* temp/.[!.]* temp/..?* . 2>/dev/null || true
          echo "âœ… å·²ç§»åŠ¨ temp/ ä¸­çš„æ–‡ä»¶åˆ°æ ¹ç›®å½•"
        fi
        # æ¸…ç† temp ç›®å½•
        rm -rf temp
        echo "ğŸ—‘ï¸ temp ç›®å½•å·²åˆ é™¤"

    # ç¬¬å…«æ­¥ï¼šåˆ é™¤ dir ç›®å½•ï¼ˆå¯é€‰ï¼‰
    - name: åˆ é™¤ dir ç›®å½•ï¼ˆå¯é€‰ï¼‰
      shell: bash
      run: |
        DIR_TO_DELETE="$FILE_DIRECTORY"
        
        if [ "${{ inputs.delete_zip_directory }}" = "true" ]; then
          if [ -d "$DIR_TO_DELETE" ]; then
            echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤ç›®å½•: $DIR_TO_DELETE"
            rm -rf "$DIR_TO_DELETE"
            if [ $? -eq 0 ]; then
              echo "âœ… å·²æˆåŠŸåˆ é™¤ç›®å½•: $DIR_TO_DELETE"
            else
              echo "âŒ åˆ é™¤ç›®å½•å¤±è´¥: $DIR_TO_DELETE"
              exit 1
            fi
          else
            echo "ğŸ”¸ ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤: $DIR_TO_DELETE"
          fi
        else
          echo "â„¹ï¸ ä¿ç•™ç›®å½•: $DIR_TO_DELETE"
        fi
      env:
        FILE_DIRECTORY: ${{ inputs.File_directory }}

    # ç¬¬ä¹æ­¥ï¼šè®¾ç½® Git ç”¨æˆ·
    - name: è®¾ç½® Git æäº¤ä¿¡æ¯
      shell: bash
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    # ç¬¬åæ­¥ï¼šæäº¤å¹¶æ¨é€
    - name: æäº¤æ›´æ”¹å¹¶æ¨é€
      shell: bash
      run: |
        git add .
        git commit -m "ğŸš€ è‡ªåŠ¨éƒ¨ç½²ï¼šæ›´æ–°ç½‘ç«™å†…å®¹ [skip ci]" || echo "ğŸ”¸ æ²¡æœ‰æ–°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        git push origin ${{ github.ref }} || echo "âš ï¸ æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ— æ›´æ”¹æˆ–åˆ†æ”¯å—ä¿æŠ¤ï¼‰"
