name: è‡ªåŠ¨éƒ¨ç½² - ä» public è§£å‹å¹¶å‘å¸ƒ
description: æ‰¾å‡º public æ–‡ä»¶å¤¹ä¸­æœ€æ–°çš„ zip åŒ…ï¼Œè§£å‹åæ›¿æ¢æ ¹ç›®å½•å†…å®¹ï¼Œå¹¶è‡ªåŠ¨æäº¤ã€‚


author: Yian

# è¾“å…¥å‚æ•°
inputs:
  zipç›®å½•:
    description: "zip æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œé»˜è®¤æ˜¯ public"
    required: false
    default: "public"

# å®šä¹‰è¿è¡Œç¯å¢ƒå’Œæ­¥éª¤
runs:
  using: "composite"
  steps:
    # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»£ç 
    - name: æ‹‰å–ä»£ç 
      uses: actions/checkout@v4

    # ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ public æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
    - name: æ£€æŸ¥ zip ç›®å½•æ˜¯å¦å­˜åœ¨
      shell: bash
      run: |
        DIR="${{ inputs.zipç›®å½• }}"
        if [ -d "$DIR" ]; then
          echo "âœ… $DIR ç›®å½•å­˜åœ¨"
        else
          echo "âŒ é”™è¯¯ï¼š$DIR ç›®å½•ä¸å­˜åœ¨ï¼è¯·ç¡®è®¤æœ‰ç”Ÿæˆ zip æ–‡ä»¶ã€‚" >&2
          exit 1
        fi

    # ç¬¬ä¸‰æ­¥ï¼šæ‰¾å‡ºæœ€æ–°çš„ zip æ–‡ä»¶
    - name: æŸ¥æ‰¾æœ€æ–°çš„ zip æ–‡ä»¶
      id: find_zip 
      shell: bash
      run: |
        cd ${{ inputs.zipç›®å½• }} || exit 1
        # æŒ‰æ—¶é—´æ’åºï¼Œå–ç¬¬ä¸€ä¸ª zip æ–‡ä»¶
        LATEST=$(ls -t *.zip 2>/dev/null | head -n 1)
        if [ -z "$LATEST" ]; then
          echo "âŒ æ²¡æœ‰åœ¨ ${{ inputs.zipç›®å½• }} æ‰¾åˆ°ä»»ä½• zip æ–‡ä»¶"
          exit 1
        else
          echo "ğŸ“¦ æ‰¾åˆ°æœ€æ–°å‹ç¼©åŒ…ï¼š$LATEST"
          # æŠŠç»“æœå­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åé¢ä½¿ç”¨
          echo "LATEST_ZIP=$LATEST" >> $GITHUB_ENV
        fi

    # ç¬¬å››æ­¥ï¼šè§£å‹åˆ° temp æ–‡ä»¶å¤¹
    - name: è§£å‹æ–‡ä»¶åˆ° temp
      shell: bash
      run: |
        unzip -o "${{ inputs.zipç›®å½• }}/$LATEST_ZIP" -d ./temp
        echo "âœ… è§£å‹å®Œæˆ"

    # ç¬¬äº”æ­¥ï¼šæ¸…ç†æ ¹ç›®å½•ï¼ˆä¿ç•™ .git .github publicï¼‰
    - name: æ¸…ç†æ—§æ–‡ä»¶
      shell: bash
      run: |
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ ¹ç›®å½•..."
        for item in ./*; do
          case "${item#./}" in
            .git|.github|public|temp)
              echo "ğŸ” ä¿ç•™: $item"
              ;;
            *)
              echo "ğŸ—‘ï¸ åˆ é™¤: $item"
              rm -rf "$item"
              ;;
          esac
        done
        echo "âœ… æ¸…ç†å®Œæˆ"

    # ç¬¬å…­æ­¥ï¼šæŠŠè§£å‹çš„å†…å®¹ç§»åˆ°æ ¹ç›®å½•
    - name: ç§»åŠ¨æ–°æ–‡ä»¶åˆ°æ ¹ç›®å½•
      shell: bash
      run: |
        mv temp/* . || { echo "ç§»åŠ¨æ–‡ä»¶å¤±è´¥"; exit 1; }
        rm -rf temp || { echo "åˆ é™¤ temp å¤±è´¥"; exit 1; }
        echo "âœ… æ–‡ä»¶å·²ç§»åŠ¨åˆ°æ ¹ç›®å½•"

    # ç¬¬ä¸ƒæ­¥ï¼šåˆ é™¤ public æ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼‰
    - name: åˆ é™¤ public ç›®å½•
      shell: bash
      run: |
        rm -rf ${{ inputs.zipç›®å½• }}
        echo "âœ… å·²åˆ é™¤ ${{ inputs.zipç›®å½• }}"

    # ç¬¬å…«æ­¥ï¼šè®¾ç½® Git ç”¨æˆ·
    - name: è®¾ç½® Git æäº¤ä¿¡æ¯
      shell: bash
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    # ç¬¬ä¹æ­¥ï¼šæäº¤å¹¶æ¨é€
    - name: æäº¤æ›´æ”¹å¹¶æ¨é€
      shell: bash
      run: |
        git add .
        # å¦‚æœæ²¡æœ‰æ›´æ”¹ï¼Œå°±ä¸æäº¤
        git commit -m "ğŸš€ è‡ªåŠ¨éƒ¨ç½²ï¼šæ›´æ–°ç½‘ç«™å†…å®¹ [skip ci]" || echo "ğŸ”¸ æ²¡æœ‰æ–°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        git push origin ${{ github.ref }} || echo "âš ï¸ æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ— æ›´æ”¹æˆ–åˆ†æ”¯å—ä¿æŠ¤ï¼‰"
